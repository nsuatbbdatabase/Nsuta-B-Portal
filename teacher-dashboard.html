<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="teacher-dashboard.css" />
</head>
<body>
  <button id="logoutBtn" class="logout-btn" style="float:right;margin:1rem;">Logout</button>
  <div class="school-header" style="display:flex;align-items:center;margin-bottom:1rem;">
    <img src="Badge.png" alt="School Logo" class="school-logo" style="height:60px;margin-right:1rem;" />
    <h1 style="margin:0;font-size:1.5rem;">Nkawkaw Nsuta M/A 'B' Basic School</h1>
  </div>
  <button id="aboutMeBtn" style="float:right;margin:1rem 1rem 0 0;">About Me</button>
  <!-- About Me Modal -->
  <div id="aboutMeModal" class="modal hidden">
    <div class="modal-content">
  <span class="close" id="closeAboutMe" onclick="closeAboutMeModal()">&times;</span>
      <h2>About Me</h2>
      <div id="aboutMeContent">
        <!-- Teacher info will be loaded here -->
      </div>
    </div>
  </div>
  <div class="dashboard-container">
    <div class="dashboard-tabs">
      <button class="tab-btn" onclick="showTab('profileSection')">Profile</button>
      <button class="tab-btn" onclick="showTab('sbaSection')">SBA Entry</button>
      <button class="tab-btn" onclick="showTab('examSection')">Exam Entry</button>
      <button class="tab-btn" onclick="showTab('assignmentSection')">Assignment Composer</button>
      <button class="tab-btn" onclick="showTab('inboxSection')">Assignment Inbox</button>
      <button class="tab-btn" onclick="showTab('messagesSection')">Messages</button>
      <button class="tab-btn" onclick="showTab('resourceRequestsSection')">Resource Requests</button>
      <button class="tab-btn" onclick="showTab('motivationSection')">Motivation</button>
    </div>

    <div id="profileSection" class="tab-section">
      <h2 id="welcomeMessage">Welcome, [Teacher Name]</h2>
      <div id="assignedRoles" class="floating-roles"></div>
      <div class="filters">
        <label for="classSelect">Class:</label>
        <select id="classSelect" onchange="loadStudents()">
          <option value="">-- Select Class --</option>
        </select>
        <label for="subjectSelect">Subject:</label>
        <select id="subjectSelect" onchange="loadStudents()">
          <option value="">-- Select Subject --</option>
        </select>
        <label for="term">Term:</label>
        <select id="term">
          <option>1st Term</option>
          <option>2nd Term</option>
          <option>3rd Term</option>
        </select>
        <label for="year">Academic Year:</label>
        <input type="text" id="year" placeholder="e.g. 2025/2026" />
      </div>
      <div id="teacher-filters" style="margin-bottom: 1em;">
        <select id="termInput">
          <option value="">-- Select Term --</option>
          <option value="1st Term">1st Term</option>
          <option value="2nd Term">2nd Term</option>
          <option value="3rd Term">3rd Term</option>
        </select>
        <input id="yearInput" placeholder="Academic Year (e.g. 2025/2026)">
      </div>
      <div id="studentListContainer"></div>
    </div>

    <div id="sbaSection" class="tab-section" style="display:none;">
      <div class="collapsible-panel">
        <button class="toggle-btn" onclick="togglePanel('sbaPanel')">SBA Entry</button>
        <div id="sbaPanel" class="panel-content">
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Individual Test (15)</th>
                <th>Group Work (15)</th>
                <th>Class Test (15)</th>
                <th>Project Work (15)</th>
                <th>Total (60)</th>
                <th>Scaled to 50</th>
              </tr>
            </thead>
            <tbody id="sbaTableBody"></tbody>
          </table>
          <button onclick="submitSBA()">Submit SBA</button>
        </div>
      </div>
    </div>

    <div id="examSection" class="tab-section" style="display:none;">
      <div class="collapsible-panel">
        <button class="toggle-btn" onclick="togglePanel('examPanel')">Exam Entry</button>
        <div id="examPanel" class="panel-content">
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>End of Term Exam (100)</th>
                <th>Scaled to 50</th>
              </tr>
            </thead>
            <tbody id="examTableBody"></tbody>
          </table>
          <button onclick="submitExams()">Submit Exams</button>
        </div>
      </div>
    </div>

    <div id="assignmentSection" class="tab-section" style="display:none;">
      <div class="assignment-composer">
        <h3>Send Assignment to Students</h3>
        <label for="assignClass">Class:</label>
        <select id="assignClass">
          <option value="">-- Select Class --</option>
        </select>
        <label for="assignSubject">Subject:</label>
        <select id="assignSubject">
          <option value="">-- Select Subject --</option>
        </select>
        <label for="assignTerm">Term:</label>
        <select id="assignTerm">
          <option>1st Term</option>
          <option>2nd Term</option>
          <option>3rd Term</option>
        </select>
        <label for="assignYear">Academic Year:</label>
        <input type="text" id="assignYear" placeholder="e.g. 2025/2026" />
        <label for="assignTitle">Assignment Title:</label>
        <input type="text" id="assignTitle" placeholder="e.g. Algebra Practice" />
        <label for="assignText">Instructions:</label>
        <textarea id="assignText" rows="4" placeholder="Describe the task..."></textarea>
        <label for="assignFile">Upload Document (optional):</label>
        <input type="file" id="assignFile" />
        <button onclick="sendAssignment()">Send Assignment</button>
      </div>
    </div>

    <div id="inboxSection" class="tab-section" style="display:none;">
      <div id="assignmentInbox">
        <h3>Student Assignment Submissions</h3>
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Assignment</th>
              <th>Date Submitted</th>
              <th>File</th>
              <th>ID</th>
            </tr>
          </thead>
          <tbody id="studentSubmissionTableBody">
            <!-- Submissions will be loaded here by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="messagesSection" class="tab-section" style="display:none;">
      <h3>Messages from Students</h3>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Message</th>
            <th>Response</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="studentMessagesTableBody">
          <!-- Messages will be loaded here by JS -->
        </tbody>
      </table>
    </div>

    <div id="resourceRequestsSection" class="tab-section" style="display:none;">
      <h3>Resource Requests</h3>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Resource</th>
            <th>Reason</th>
            <th>Response</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="resourceRequestsTableBody">
          <!-- Requests will be loaded here by JS -->
        </tbody>
      </table>
    </div>

    <div id="motivationSection" class="tab-section" style="display:none;">
      <h3>Send Motivational Message</h3>
      <label for="motivationStudentSelect">Student:</label>
      <select id="motivationStudentSelect">
        <option value="">-- Select Student --</option>
        <!-- Student options will be populated by JS -->
      </select>
      <label for="motivationText">Message:</label>
      <input type="text" id="motivationText" placeholder="Type your message..." />
      <button onclick="sendMotivationalMessage()">Send</button>
      <h4>Motivational Messages Sent</h4>
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Message</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="motivationalMessagesTableBody">
          <!-- Messages will be loaded here by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Supabase + Logic -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="teacher-dashboard.js"></script>
  <script src="router.js"></script>
</body>
<script>
  // Modal controls
  function openAboutMeModal() {
    document.getElementById('aboutMeModal').classList.remove('hidden');
  }
  function closeAboutMeModal() {
    document.getElementById('aboutMeModal').classList.add('hidden');
  }
  document.getElementById('aboutMeBtn').onclick = async function() {
    const staffId = sessionStorage.getItem('teacher_staff_id');
    if (!staffId) {
      document.getElementById('aboutMeContent').innerHTML = '<p style="color:red;">No teacher session found. Please log in again.</p>';
      openAboutMeModal();
      return;
    }
    const { data, error } = await supabase.createClient(
      'https://omhmahhfeduejykrxflx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9taG1haGhmZWR1ZWp5a3J4Zmx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MDI5NDAsImV4cCI6MjA3MjM3ODk0MH0.UL7cRM4JUEZRqhXarRf8xQDyobvoOxa8eXfG8h9wNHo'
    ).from('teachers').select('*').eq('staff_id', staffId).single();
    if (error || !data) {
      document.getElementById('aboutMeContent').innerHTML = '<p style="color:red;">Could not load teacher info. Please log in again.</p>';
      openAboutMeModal();
      return;
    }
    let html = '<table class="about-me-table">';
    for (const [key, value] of Object.entries(data)) {
      html += `<tr><td><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong></td><td>${Array.isArray(value) ? value.join(', ') : value || ''}</td></tr>`;
    }
    html += '</table>';
    document.getElementById('aboutMeContent').innerHTML = html;
    openAboutMeModal();
  };
  // Allow closing modal by clicking outside or pressing Escape
  window.onclick = function(event) {
    const modal = document.getElementById('aboutMeModal');
    if (event.target === modal) {
      closeAboutMeModal();
    }
  };
  window.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') closeAboutMeModal();
  });
</script>
<script>
  window.showTab = function(tabId) {
  document.querySelectorAll('.tab-section').forEach(section => {
    section.style.display = 'none';
  });
  document.getElementById(tabId).style.display = 'block';
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active');
  });
}
showTab('profileSection'); // Show profile by default
</script>
</body>
<script>
  document.getElementById('logoutBtn').onclick = function() {
    sessionStorage.clear();
    localStorage.clear();
    // Remove all possible teacher session keys
    sessionStorage.removeItem('teacher_staff_id');
    localStorage.removeItem('teacherId');
    // Redirect to login page (index.html or login.html)
    window.location.href = 'index.html';
  };
</script>
</body>
</html>